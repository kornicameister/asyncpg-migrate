---
x-prepare: &install_prepare
  run:
    name: "Install/Upgrade tox & pip"
    command: |
      sudo chown -R circleci:circleci /usr/local/bin
      sudo chown -R circleci:circleci /usr/local/lib/python$(python --version | sed -e 's/Python\s//g' | awk -F'.' '{print $1"."$2}')/site-packages
      pip install pip tox --upgrade
x-test-steps: &test_steps
  working_directory: ~/app
  steps:
    - checkout
    - <<: *install_prepare
    - run:
        name: Unit test
        command: tox -v -e test_unit

orbs:
  docker: circleci/docker@0.5.2

version: 2.1
jobs:
  verify:
    working_directory: ~/app
    docker:
      - image: circleci/python:3.7.3
    steps:
      - checkout
      - <<: *install_prepare
      - run:
          name: Check formatting
          command: tox -v -e yapf
      - run:
          name: Check mypy
          command: tox -v -e mypy
      - run:
          name: Check flake
          command: tox -v -e flake8
  test_36:
    <<: *test_steps
    docker:
      - image: circleci/python:3.6.8
  test_37:
    <<: *test_steps
    docker:
      - image: circleci/python:3.7.3
  test_integration:
    working_directory: ~/app
    machine: true
    steps:
      - checkout
      - docker/install-docker
      - docker/install-docker-compose
      - docker/build:
          dockerfile: .circleci/Dockerfile
          image: asynpg_migrate_integration
          step-name: Build image for intergration tests
          tag: latest
      - run:
          name: Do test
          command: docker-compose -f .circleci/docker-compose.yml up -d --exit-code-from test
      - run:
          name: Finish this
          command: docker-compose -f .circleci/docker-compose.yml down

workflows:
  version: 2
  apg-m-verify:
    jobs:
      - verify
      - test_36
      - test_37
      - test_integration:
          requires:
            - test_36
            - test_37
